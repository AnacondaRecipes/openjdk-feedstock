# Based on recipes from birdhouse and anaconda channel.

{% set name = "openjdk" %}
{% set version = "17.0.4.1" %}
{% set ver_parts = version.split('.') %}
{% set intellij_build = "629.2" %}
{% set build_number = 0 %}

{% set sha256_osx = "9fa76309c1a46de2269c373e8e3c3e4bb7c1f0ff2a3d03176b0169962968b178" %}
{% set sha256_jbrex_osx = "210aae3ea8d08b118847895b27acb67cfddb8c7a4ece86c845f111839a4ce026" %}

{% set sha256_osx_arm64 = "e84a8f0e7e9bd1675af86097b5d7fc958351408b1ccbb4d99e23006ab70c9e73" %}
{% set sha256_jbrex_osx_arm64 = "ce6cb9f431aa840fa2ae1ff6bba494b40e79ceabc9a8169ba34a2c46a23fbbce" %}

{% set sha256_linux_64 = "3acf6387aecc5b2fe9411b9a64507d9442431637e09923826b5a8368c21cbe4a" %}
{% set sha256_jbrex_linux_64 = "4304ba9f8554afed8e78079a11add045aafd926a46e4ef8b6f3427043916e3a3" %}

{% set sha256_linux_aarch64 = "66ce8e9cca8b759d2f55ce064eaf9e161b5f493cacde955dbc1710f79b4477e3" %}
{% set sha256_jbrex_linux_aarch64 = "8a2aca9838693f63d998c22d6076714de4da1c1c5bc7cfd83711ba4082788fe2" %}

{% set sha256_win_64 = "b95ebb8030dfecd18b761a48f8fd936d3bedeae4a0101d2fa842be847b1ad2ce" %}
{% set sha256_jbrex_win_64 = "36a79b9f6fad0d5b333f4c471422b17ae373f39f0f3e7dcb05d33074b6e0db7e" %}

{% set sha256_dejavu_fonts = "7576310b219e04159d35ff61dd4a4ec4cdba4f35c00e002a136f00e96a908b0a" %}

package:
  name: {{ name|lower }}
  version: {{ version }}

source:
  - url: https://cache-redirector.jetbrains.com/intellij-jbr/jbrsdk-{{ version }}-osx-x64-b{{ intellij_build }}.tar.gz                       # [osx and not arm64]
    fn: jbrsdk-{{ version }}-osx-x64-b{{ intellij_build }}.tar.gz                                                                            # [osx and not arm64]
    sha256: {{ sha256_osx }}                                                                                                                  # [osx and not arm64]
  - url: https://cache-redirector.jetbrains.com/intellij-jbr/jbrsdk_jcef-{{ version }}-osx-x64-b{{ intellij_build }}.tar.gz                  # [osx and not arm64]
    fn: jbrsdk_jcef-{{ version }}-osx-x64-b{{ intellij_build }}.tar.gz                                                                       # [osx and not arm64]
    sha256: {{ sha256_jbrex_osx }}                                                                                                            # [osx and not arm64]
  - url: https://cache-redirector.jetbrains.com/intellij-jbr/jbrsdk-{{ version }}-osx-aarch64-b{{ intellij_build }}.tar.gz                   # [osx and arm64]
    fn: jbrsdk-{{ version }}-osx-aarch64-b{{ intellij_build }}.tar.gz                                                                        # [osx and arm64]
    sha256: {{ sha256_osx_arm64 }}                                                                                                            # [osx and arm64]
  - url: https://cache-redirector.jetbrains.com/intellij-jbr/jbrsdk_jcef-{{ version }}-osx-aarch64-b{{ intellij_build }}.tar.gz              # [osx and arm64]
    fn: jbrsdk_jcef-{{ version }}-osx-aarch64-b{{ intellij_build }}.tar.gz                                                                   # [osx and arm64]
    sha256: {{ sha256_jbrex_osx_arm64 }}                                                                                                      # [osx and arm64]
  - url: https://cache-redirector.jetbrains.com/intellij-jbr/jbrsdk-{{ version }}-linux-x64-b{{ intellij_build }}.tar.gz                     # [linux and not aarch64]
    fn: jbrsdk-{{ version }}-linux-x64-b{{ intellij_build }}.tar.gz                                                                          # [linux and not aarch64]
    sha256: {{ sha256_linux_64 }}                                                                                                             # [linux and not aarch64]
  - url: https://cache-redirector.jetbrains.com/intellij-jbr/jbrsdk_jcef-{{ version }}-linux-x64-b{{ intellij_build }}.tar.gz                # [linux and not aarch64]
    fn: jbrsdk_jcef-{{ version }}-linux-x64-b{{ intellij_build }}.tar.gz                                                                     # [linux and not aarch64]
    sha256: {{ sha256_jbrex_linux_64 }}                                                                                                       # [linux and not aarch64]
  - url: https://cache-redirector.jetbrains.com/intellij-jbr/jbrsdk-{{ version }}-linux-aarch64-b{{ intellij_build }}.tar.gz                 # [linux and aarch64]
    fn: jbrsdk-{{ version }}-linux-aarch64-b{{ intellij_build }}.tar.gz                                                                      # [linux and aarch64]
    sha256: {{ sha256_linux_aarch64 }}                                                                                                        # [linux and aarch64]
  - url: https://cache-redirector.jetbrains.com/intellij-jbr/jbrsdk_jcef-{{ version }}-linux-aarch64-b{{ intellij_build }}.tar.gz            # [linux and aarch64]
    fn: jbrsdk_jcef-{{ version }}-linux-aarch64-b{{ intellij_build }}.tar.gz                                                                 # [linux and aarch64]
    sha256: {{ sha256_jbrex_linux_aarch64 }}                                                                                                  # [linux and aarch64]                                                                                                                          # [linux]
  - url: https://cache-redirector.jetbrains.com/intellij-jbr/jbrsdk-{{ version }}-windows-x64-b{{ intellij_build }}.tar.gz                   # [win64]
    fn: jbrsdk-{{ version }}-windows-x64-b{{ intellij_build }}.tar.gz                                                                        # [win64]
    sha256: {{ sha256_win_64 }}                                                                                                               # [win64]
  - url: https://cache-redirector.jetbrains.com/intellij-jbr/jbrsdk_jcef-{{ version }}-windows-x64-b{{ intellij_build }}.tar.gz              # [win64]
    fn: jbrsdk_jcef-{{ version }}-windows-x64-b{{ intellij_build }}.tar.gz                                                                   # [win64]
    sha256: {{ sha256_jbrex_win_64 }}                                                                                                         # [win64]
  - url: https://github.com/dejavu-fonts/dejavu-fonts/releases/download/version_2_37/dejavu-fonts-ttf-2.37.zip                                # [linux]
    sha256: {{ sha256_dejavu_fonts }}                                                                                                         # [linux]
    folder: fonts                                                                                                                             # [linux]

build:
  number: {{ build_number }}
  skip: True  # [ppc64le or s390x or win32]
  ignore_run_exports:
    - cairo              # [linux and aarch64]
    - dbus               # [linux]
    - expat              # [linux]
    - freetype           # [linux]
    - libxcb             # [linux]
    - pango              # [linux and aarch64]
    - zlib               # [osx]
  missing_dso_whitelist:
    - $RPATH/libz.so.1
    - $RPATH/libjli.so
    - $RPATH/libjvm.so
    - $RPATH/libgobject-2.0.so.0
    - $RPATH/libglib-2.0.so.0
    - $RPATH/libnss3.so
    - $RPATH/libdrm.so.2
    - $RPATH/libgbm.so.1
    - $RPATH/libnssutil3.so
    - $RPATH/libsmime3.so
    - $RPATH/libnspr4.so
    - $RPATH/libatk-1.0.so.0
    - $RPATH/libatk-bridge-2.0.so.0
    - $RPATH/libgio-2.0.so.0
    - $RPATH/libxkbcommon.so.0
    - $RPATH/libX11.so.6
    - $RPATH/libXcomposite.so.1
    - $RPATH/libXdamage.so.1
    - $RPATH/libXext.so.6
    - $RPATH/libXfixes.so.3
    - $RPATH/libXrandr.so.2
    - $RPATH/libasound.so.2
    - $RPATH/libcups.so.2
    - $RPATH/libatspi.so.0
    - $RPATH/libxshmfence.so.1
    - $RPATH/libjawt.so
    - $RPATH/libXrender.so.1
    - $RPATH/libXtst.so.6
    - $RPATH/libXi.so.6
    - $RPATH/libXxf86vm.so.1
    - $RPATH/libXcursor.so.1
    - $RPATH/libstdc++.so.6
    - $RPATH/libjvm.dylib               # [osx]
    - $RPATH/libjawt.dylib              # [osx]
    - $RPATH/libpangoft2-1.0.so.0       # [linux and aarch64]
    - $RPATH/libgtk-x11-2.0.so.0        # [linux and aarch64]
    - $RPATH/libgdk-x11-2.0.so.0        # [linux and aarch64]
    - $RPATH/libgdk_pixbuf-2.0.so.0     # [linux and aarch64]
    - $RPATH/libgthread-2.0.so.0        # [linux and aarch64]
    - $RPATH/ld-linux-x86-64.so.2       # [linux and aarch64]
    - $RPATH/libgtk-3.so.0              # [linux and aarch64]
    - $RPATH/libgdk-3.so.0              # [linux and aarch64]
    - $RPATH/libavcodec-ffmpeg.so.56    # [linux and aarch64]
    - $RPATH/libavformat-ffmpeg.so.56   # [linux and aarch64]
    - $RPATH/libGL.so.1                 # [linux and aarch64]
    - $RPATH/libgmodule-2.0.so.0        # [linux and aarch64]
    - /*/*/*/*/*/*/*/Frameworks/JavaNativeFoundation.framework/JavaNativeFoundation  # [osx and arm64]
    - Library\bin\VCRUNTIME140.dll      # [win]
    - Library\bin\bin\VCRUNTIME140.dll  # [win]
    - Library\bin\MSVCP140.dll          # [win]
    - Library\bin\bin\MSVCP140.dll      # [win]
    - $RPATH/jvm.dll                    # [win]

requirements:
  build:
    - {{ compiler('cxx') }}   # [not win]
    - zip                     # [linux]
  host:
    - cairo                   # [linux and aarch64]
    - dbus                    # [linux]
    - expat                   # [linux]
    - freetype                # [linux]
    - glib                    # [linux]
    - libxcb                  # [linux]
    - pango                   # [linux and aarch64]
    - zlib                    # [unix]
  run:
    - cairo                   # [linux and aarch64]
    - dbus                    # [linux]
    - expat                   # [linux]
    - freetype                # [linux]
    - glib                    # [linux]
    - libxcb                  # [linux]
    - pango                   # [linux and aarch64]
 
test:
  requires:
    - {{ compiler('c') }}
  files:
    - test-jni     # [not win]
    - test-jni.sh  # [not win]
    - test-nio
  commands:
    - java -version
    - ./test-jni.sh                                # [not win]
    - conda inspect linkages -p ${PREFIX} openjdk  # [linux]
    - conda inspect objects -p ${PREFIX} openjdk   # [osx]

about:
  home: https://github.com/JetBrains/JetBrainsRuntime
  license: GPL-2.0-only
  license_family: GPL
  summary: The JetBrains Runtime OpenJDK build.
  description: |
    JetBrains Runtime is a runtime environment for running
    IntelliJ Platform based products on Windows, Mac OS X, and Linux
  dev_url: https://github.com/JetBrains/JetBrainsRuntime

extra:
  recipe-maintainers:
    - johanneskoester
    - mingwandroid
    - sodre
